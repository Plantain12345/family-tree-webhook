<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Family Tree</title>
  <style>
    :root { --fg:#111; --muted:#666; --line:#eee; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: var(--fg); }
    header { padding: 10px 14px; border-bottom: 1px solid var(--line); display: flex; align-items: center; gap: 10px; }
    h1 { font-size: 16px; margin: 0; }
    #status { font-size: 12px; color: var(--muted); margin-left: auto; }
    #cy { width: 100vw; height: calc(100vh - 48px); display: block; }
    #empty { position: absolute; inset: 48px 0 0 0; display: none; align-items: center; justify-content: center; }
    #empty .box { text-align: center; color: var(--muted); padding: 24px; }
  </style>
</head>
<body>
  <header>
    <h1 id="title">Family Tree</h1>
    <div id="status">Loading…</div>
  </header>

  <div id="cy"></div>
  <div id="empty"><div class="box">
    <div style="font-size:18px;margin-bottom:8px;">No people yet</div>
    <div>Use WhatsApp to add: “Add Alice born 1950”, “Link Alice married to Bob”.</div>
  </div></div>

  <script src="https://unpkg.com/cytoscape@3.27.0/dist/cytoscape.min.js"></script>
  <script>
    const qs = new URLSearchParams(location.search);
    const code = (qs.get("code") || "").toUpperCase();
    const titleEl = document.getElementById("title");
    const statusEl = document.getElementById("status");
    const emptyEl = document.getElementById("empty");

    if (!/^[A-Z0-9]{6}$/.test(code)) {
      document.body.innerHTML = "<p style='padding:16px'>Missing or bad code. Use ?code=ABC123</p>";
      throw new Error("bad code");
    }

    const cy = cytoscape({
      container: document.getElementById('cy'),
      elements: [],
      style: [
        { selector: 'node',
          style: {
            'shape': 'round-rectangle',
            'background-color': '#fff',
            'border-color': '#777',
            'border-width': 1,
            'label': 'data(label)',
            'text-wrap': 'wrap',
            'text-max-width': 180,
            'padding': '8px',
            'font-size': 12
          }
        },
        { selector: 'edge',
          style: {
            'width': 1,
            'line-color': '#bbb',
            'target-arrow-color': '#bbb',
            'curve-style': 'bezier',
            'target-arrow-shape': 'triangle',
            'label': 'data(kind)',
            'font-size': 9,
            'text-rotation': 'autorotate',
            'text-margin-y': -6,
            'opacity': 0.9
          }
        },
        { selector: 'edge[kind = "spouse_of"], edge[kind = "partner_of"]',
          style: { 'target-arrow-shape': 'none', 'line-style': 'solid' }
        },
        { selector: 'edge[kind = "parent_of"]',
          style: { 'target-arrow-shape': 'triangle' }
        }
      ],
      layout: { name: 'breadthfirst', directed: true, padding: 20, spacingFactor: 1.2 }
    });

    async function load() {
      statusEl.textContent = "Loading…";
      try {
        const r = await fetch(`/api/tree?code=${code}`, { cache: 'no-store' });
        const data = await r.json();
        if (!r.ok) {
          statusEl.textContent = `Error: ${data.error || r.status}`;
          emptyEl.style.display = 'flex';
          return;
        }

        titleEl.textContent = `${data.tree.name} — ${data.tree.code}`;

        cy.startBatch();
        cy.elements().remove();
        cy.add(data.nodes);
        cy.add(data.edges);
        cy.endBatch();

        cy.layout({ name: 'breadthfirst', directed: true, padding: 20, spacingFactor: 1.2 }).run();

        emptyEl.style.display = (data.nodes.length || data.edges.length) ? 'none' : 'flex';
        statusEl.textContent = `Updated ${new Date().toLocaleTimeString()}`;
      } catch (e) {
        console.error(e);
        statusEl.textContent = "Error loading";
        emptyEl.style.display = 'flex';
      }
    }

    load();
    setInterval(load, 8000);
  </script>
</body>
</html>
