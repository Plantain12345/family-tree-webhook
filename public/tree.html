<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Family Tree</title>
  <style>
    :root {
      --bg: #ffffff;
      --surface: #ffffff;
      --panel: #fbf7f2;
      --ink: #2f2217;
      --muted: #6f6255;
      --border: #e8ded2;
      --accent: #d87b5d;
      --status-bg: rgba(216, 123, 93, 0.12);
    }

    html,
    body {
      margin: 0;
      min-height: 100%;
      font-family: "Inter", "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--ink);
      background: var(--bg);
    }

    body {
      display: flex;
      flex-direction: column;
    }

    .shell {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 24px;
      padding: 28px 36px 20px;
      background: var(--surface);
      box-shadow: 0 12px 32px rgba(21, 12, 4, 0.05);
      z-index: 10;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .title-prefix {
      text-transform: uppercase;
      letter-spacing: 0.18em;
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
    }

    h1 {
      margin: 0;
      font-size: 26px;
      font-weight: 600;
    }

    #status {
      font-size: 12px;
      font-weight: 500;
      color: var(--accent);
      background: var(--status-bg);
      padding: 8px 14px;
      border-radius: 999px;
      align-self: flex-start;
      white-space: nowrap;
    }

    main {
      flex: 1;
      position: relative;
      padding: 24px 36px 36px;
      background: linear-gradient(180deg, rgba(248, 242, 236, 0.55) 0%, rgba(255, 255, 255, 0.9) 60%, rgba(255, 255, 255, 1) 100%);
      display: flex;
      flex-direction: column;
    }

    .legend {
      position: absolute;
      top: 42px;
      right: 56px;
      display: flex;
@@ -190,56 +165,50 @@
      flex-direction: column;
      gap: 10px;
    }

    .alerts strong {
      font-size: 13px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--accent);
    }

    .alerts ul {
      margin: 0;
      padding-left: 18px;
      font-size: 13px;
      color: var(--muted);
    }

    @media (max-width: 720px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 18px;
      }

      .legend {
        position: static;
        margin-bottom: 16px;
        flex-wrap: wrap;
        justify-content: center;
      }

      .alerts {
        margin-top: 12px;
        align-self: stretch;
      }

      #empty {
        inset: 24px;
      }
    }

    #cy {
      width: 100%;
      flex: 1;
      min-height: 480px;
      border-radius: 26px;
      background: var(--panel);
      border: 1px solid var(--border);
      box-shadow: 0 28px 60px rgba(27, 17, 8, 0.08);
@@ -257,89 +226,83 @@
    #empty .box {
      text-align: center;
      color: var(--muted);
      padding: 32px 40px;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.65);
      box-shadow: 0 18px 44px rgba(17, 10, 4, 0.08);
      border: 1px solid var(--border);
    }

    #empty .box strong {
      display: block;
      font-size: 18px;
      margin-bottom: 6px;
      color: var(--ink);
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div class="title-block">
        <span class="title-prefix">Family Tree:</span>
        <h1 id="tree-name">Loading…</h1>
      </div>
      <div id="status">Loading…</div>
    </header>

    <main>
      <div class="legend">
        <span class="legend-item"><span class="legend-swatch male"></span>Male</span>
        <span class="legend-item"><span class="legend-swatch female"></span>Female</span>
        <span class="legend-item"><span class="legend-swatch neutral"></span>Non-binary</span>
        <span class="legend-item"><span class="legend-swatch unknown"></span>Not specified</span>
      </div>
      <div id="alerts" class="alerts" hidden></div>
      <div id="cy"></div>
      <div id="empty"><div class="box">
        <strong>Invite your family</strong>
        <div>Use WhatsApp to add relatives—try “Add Alice born 1950” or “Link Alice married to Bob”.</div>
      </div></div>
    </main>
  </div>

  <script src="https://unpkg.com/cytoscape@3.27.0/dist/cytoscape.min.js"></script>
  <script>
    const qs = new URLSearchParams(location.search);
    const code = (qs.get("code") || "").toUpperCase();
    const treeNameEl = document.getElementById("tree-name");
    const statusEl = document.getElementById("status");
    const emptyEl = document.getElementById("empty");
    const alertsEl = document.getElementById("alerts");

    if (!/^[A-Z0-9]{6}$/.test(code)) {
      document.body.innerHTML = "<p style='padding:16px'>Missing or bad code. Use ?code=ABC123</p>";
      throw new Error("bad code");
    }


    const LEVEL_HEIGHT = 200;
    const SPOUSE_GAP = 220;
    const UNIT_GAP = 280;
    const CHILD_GAP = 150;
    const DROP_GAP = 90;
    const DROP_SEGMENT = DROP_GAP / 2;
    const DIVORCE_OFFSET = 32;

    const cy = cytoscape({
      container: document.getElementById('cy'),
      elements: [],
      style: [
        {
          selector: 'node[type = "person"]',
          style: {
            'shape': 'data(shape)',
            'width': 'data(width)',
            'height': 'data(height)',
            'background-color': 'data(color)',
            'border-color': '#d8cec2',
            'border-width': 2,
            'label': 'data(label)',
            'text-wrap': 'wrap',
            'text-max-width': 112,
@@ -825,51 +788,50 @@
        case 'male':
          return { color: '#c8daf9', shape: 'square', width: 120, height: 120 };
        case 'female':
          return { color: '#f8d5e4', shape: 'ellipse', width: 120, height: 120 };
        case 'nonbinary':
        case 'non-binary':
        case 'nb':
          return { color: '#e3dbf7', shape: 'round-diamond', width: 130, height: 130 };
        default:
          return { color: '#f4efe7', shape: 'round-rectangle', width: 148, height: 112 };
      }
    }

    async function load() {
      statusEl.textContent = "Loading…";
      try {
        const r = await fetch(`/api/tree?code=${code}`, { cache: 'no-store' });
        const data = await r.json();
        if (!r.ok) {
          statusEl.textContent = `Error: ${data.error || r.status}`;
          emptyEl.style.display = 'flex';
          return;
        }

        treeNameEl.textContent = data.tree.name;
        document.title = `Family Tree: ${data.tree.name}`;

        const layout = buildPedigreeLayout(data.nodes || [], data.edges || [], data.families || []);

        const issueMessages = (data.issues || []).map(renderIssueMessage).filter(Boolean);
        updateIssuesPanel(issueMessages);

        cy.startBatch();
        cy.elements().remove();
        cy.add(layout.personElements);
        if (layout.connectorNodes.length) cy.add(layout.connectorNodes);
        if (layout.connectorEdges.length) cy.add(layout.connectorEdges);
        cy.endBatch();

        const personCount = layout.personElements.length;
        emptyEl.style.display = personCount ? 'none' : 'flex';
        cy.resize();
        if (personCount) {
          const people = cy.collection('node[type = "person"]');
          cy.fit(people, 140);
        }

        const stamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        if (issueMessages.length) {
          statusEl.textContent = `Warnings · ${issueMessages.length} issue${issueMessages.length === 1 ? '' : 's'}`;
        } else {
          statusEl.textContent = `Synced · ${stamp}`;
        }
      } catch (e) {
        console.error(e);
        statusEl.textContent = "Error loading";
        emptyEl.style.display = 'flex';
        updateIssuesPanel([]);
      }
    }

    load();
    setInterval(load, 8000);

    function describePerson(person) {
      if (!person) return 'Unknown person';
      const parts = [];
      if (person.name) parts.push(person.name);
      if (person.dob) parts.push(`b. ${person.dob}`);
      return parts.join(' ');
    }

    function renderIssueMessage(issue) {
      if (!issue || typeof issue !== 'object') return null;
      if (issue.type === 'parent_age_anomaly') {
        const parent = describePerson(issue.parent);
        const child = describePerson(issue.child);
        return `${parent} is recorded as a parent of ${child}, but the parent is younger than the child.`;
      }
      if (issue.type === 'duplicate_person') {
        const people = Array.isArray(issue.people) ? issue.people.map(describePerson).join(', ') : '';
        if (!people) return 'Duplicate person records detected.';
        return `Duplicate person records detected for ${people}. The assistant may be adding a new entry instead of updating.`;
      }
      return null;
    }

    function updateIssuesPanel(messages) {
      if (!alertsEl) return;
      alertsEl.innerHTML = '';
      if (!messages || !messages.length) {
        alertsEl.classList.remove('visible');
        alertsEl.style.display = 'none';
        alertsEl.setAttribute('hidden', '');
        return;
      }

      alertsEl.removeAttribute('hidden');
      alertsEl.classList.add('visible');
      alertsEl.style.display = 'flex';

      const heading = document.createElement('strong');
      heading.textContent = 'Data needs attention';
      alertsEl.appendChild(heading);

      const list = document.createElement('ul');
      messages.forEach((message) => {
        if (!message) return;
        const item = document.createElement('li');
        item.textContent = message;
        list.appendChild(item);
      });

      if (!list.children.length) {
        alertsEl.classList.remove('visible');
        alertsEl.style.display = 'none';
        alertsEl.setAttribute('hidden', '');
        return;
      }

      alertsEl.appendChild(list);
    }
  </script>
</body>
</html>
